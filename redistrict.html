<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turkey â€¢ Redistricter (Replica)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11141b;
      --panel2:#0e1117;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#6b7280;
      --border:#1f2937;
      --border2:#2a3444;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --shadow2: 0 10px 32px rgba(0,0,0,.45);
      --radius: 10px;
      --radius2: 8px;
      --accent:#3b82f6;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --chip:#0b1220;
      --row:#0f1523;
      --row2:#0c111c;
      --hover:#121a2d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(900px 500px at 12% 8%, rgba(59,130,246,.14), transparent 55%),
                  radial-gradient(900px 500px at 82% 10%, rgba(239,68,68,.10), transparent 55%),
                  radial-gradient(1100px 700px at 60% 88%, rgba(34,197,94,.10), transparent 58%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
    }

    /* ===== Top bar (Redistricter-ish) ===== */
    .top{
      position:fixed;
      top:0; left:0; right:0;
      height:56px;
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.82), rgba(0,0,0,.55));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.06);
      z-index: 2000;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo .mark{
      width:34px; height:34px;
      border-radius: 10px;
      background: linear-gradient(135deg, #ff2d55, #7c3aed);
      box-shadow: 0 10px 20px rgba(0,0,0,.40);
      display:grid; place-items:center;
      font-weight: 1000;
      letter-spacing: -0.03em;
    }
    .search{
      display:flex; align-items:center; gap:10px;
      background: rgba(17,20,27,.72);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 8px 10px;
      min-width: 240px;
      box-shadow: var(--shadow2);
    }
    .search input{
      width: 100%;
      border:none;
      outline:none;
      color: var(--text);
      background: transparent;
      font-weight: 900;
      letter-spacing: -0.01em;
    }
    .search .hint{ color: var(--muted2); font-size: 12px; font-weight: 800; }

    .menus{
      display:flex; align-items:center; gap:10px;
      margin-left: 10px;
      flex: 1 1 auto;
    }
    .menu{
      position:relative;
    }
    .menu button{
      height: 34px;
      padding: 0 12px;
      border-radius: 10px;
      background: rgba(17,20,27,.66);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
    }
    .menu button:hover{ background: rgba(17,20,27,.88); }
    .dropdown{
      position:absolute;
      top: 40px; left: 0;
      min-width: 240px;
      padding: 8px;
      background: rgba(15,17,23,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 2001;
    }
    .dropdown .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 9px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 900;
      color: var(--text);
    }
    .dropdown .item:hover{ background: rgba(59,130,246,.14); }
    .dropdown .item .sub{ color: var(--muted2); font-weight: 800; font-size: 12px; }
    .dropdown select{
      height: 30px;
      padding: 0 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,20,27,.80);
      color: var(--text);
      font-weight: 950;
      outline:none;
    }

    .dropdown hr{
      border:0; height:1px; background: rgba(255,255,255,.08);
      margin: 8px 0;
    }

    .top-right{
      display:flex; align-items:center; gap:10px;
    }
    .iconbtn{
      width:34px; height:34px;
      border-radius: 10px;
      background: rgba(17,20,27,.66);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .iconbtn:hover{ background: rgba(17,20,27,.88); }

    /* ===== Layout ===== */
    .shell{
      position:fixed;
      inset: 56px 0 0 0;
      display:grid;
      grid-template-columns: 290px 340px 1fr 320px;
      gap: 10px;
      padding: 10px;
      min-height: 0;
    }
    .panel{
      background: rgba(17,20,27,.82);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .panel .phead{
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .phead .title{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -0.02em;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel .phead .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(59,130,246,.12);
      border:1px solid rgba(59,130,246,.22);
      font-weight: 1000;
      color: #c7d2fe;
      font-size: 12px;
    }
    .panel .pbody{
      padding: 10px 12px;
      overflow:auto;
      min-height: 0;
    }

    /* ===== District list ===== */
    .district-controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .dc-left{
      display:flex; align-items:center; gap:10px;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }
    .count{
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 6px 8px;
    }
    .count button{
      width:26px; height:26px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,20,27,.72);
      color: var(--text);
      cursor:pointer;
      font-weight: 1000;
    }
    .count span{ min-width: 14px; text-align:center; font-weight: 1000; color: var(--text); }

    .toolrow{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .toolrow select{
      width: 100%;
      height: 32px;
      padding: 0 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,20,27,.80);
      color: var(--text);
      font-weight: 950;
      outline:none;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-variant-numeric: tabular-nums;
    }
    thead th{
      text-align:left;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 1000;
      background: rgba(0,0,0,.10);
      border-bottom: 1px solid rgba(255,255,255,.08);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
    }
    tbody tr{
      background: rgba(0,0,0,.04);
      cursor:pointer;
    }
    tbody tr:hover{ background: rgba(59,130,246,.10); }
    tbody tr.active{ background: rgba(59,130,246,.18); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .sw{
      width:10px; height:10px;
      border-radius: 3px;
      background: #64748b;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .devpos{ color: #fecaca; }
    .devneg{ color: #bbf7d0; }
    .devna{ color: var(--muted2); font-weight: 800; }

    /* ===== Map settings ===== */
    .section{
      margin-top: 14px;
    }
    .section h4{
      margin: 0;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: -0.01em;
      background: rgba(0,0,0,.10);
      border-top: 1px solid rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .tog{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      gap:10px;
    }
    .tog label{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      color: var(--text);
      font-size: 13px;
      cursor:pointer;
    }
    .tog input{ accent-color: var(--accent); }

    /* ===== Data cards (middle + right) ===== */
    .addbtn{
      width: 100%;
      height: 38px;
      border-radius: 10px;
      border: 1px solid rgba(59,130,246,.24);
      background: rgba(59,130,246,.14);
      color: #dbeafe;
      font-weight: 1000;
      cursor:pointer;
    }
    .addbtn:hover{ background: rgba(59,130,246,.20); }

    .datacard{
      margin-top: 10px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      overflow:hidden;
    }
    .dhead{
      padding: 10px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .dhead .left{
      display:flex; align-items:center; gap:10px;
      font-weight: 1000;
    }
    .dhead .dot{
      width: 10px; height: 10px;
      border-radius: 3px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dhead .right{
      display:flex; align-items:center; gap:8px;
      color: var(--muted);
      font-weight: 950;
      font-size: 12px;
    }
    .dhead .mini{
      width: 22px; height: 22px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(17,20,27,.66);
      color: var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .dbody{
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:none;
    }
    .datacard.open .dbody{ display:block; }

    .kv{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 0;
      font-variant-numeric: tabular-nums;
    }
    .kv .k{ color: var(--muted); font-weight: 900; font-size: 12px; }
    .kv .v{ color: var(--text); font-weight: 1000; font-size: 13px; text-align:right; }

    .bars{
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .bar{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .track{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(59,130,246,.75);
      transition: width .15s ease;
    }
    .bar .lab{
      display:flex; align-items:center; gap:8px;
      font-size: 12px;
      font-weight: 1000;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .bar .lab .sw{ box-shadow: 0 0 0 3px rgba(255,255,255,.06); }
    .bar .val{
      font-size: 12px;
      color: var(--muted);
      font-weight: 950;
      text-align:right;
      white-space: nowrap;
    }

    /* ===== Map column ===== */
    .mapwrap{
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      min-height:0;
    }
    #map{ position:absolute; inset:0; }
    .maphud{
      position:absolute;
      top: 10px; left: 10px;
      z-index: 1200;
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(0,0,0,.50);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 8px 10px;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
      max-width: 520px;
    }
    .maphud .small{
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }
    .maphud .chip{
      color: #dbeafe;
      background: rgba(59,130,246,.18);
      border:1px solid rgba(59,130,246,.24);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      white-space:nowrap;
    }

    /* Leaflet cosmetics */
    .leaflet-control-zoom{
      border-radius: 10px !important;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12) !important;
      box-shadow: var(--shadow2);
    }
    .leaflet-bar a{
      background: rgba(0,0,0,.55) !important;
      color: var(--text) !important;
      border-bottom:1px solid rgba(255,255,255,.10) !important;
    }
    .leaflet-container{
      background: #0a0d13;
      outline: none;
    }
    .leaflet-tooltip{
      background: rgba(17,20,27,.95);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: var(--shadow);
      font-weight: 1000;
    }

    @media (max-width: 1200px){
      .shell{ grid-template-columns: 260px 320px 1fr; }
      .rightpanel{ display:none; }
    }
    @media (max-width: 900px){
      .shell{ grid-template-columns: 1fr; }
      .panel{ display:none; }
      .mapwrap{ border-radius: 0; }
      .top{ position:sticky; }
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <div class="top">
    <div class="logo">
      <div class="mark">R</div>
      <div class="search" title="Search a province/district; press Enter">
        <span class="hint">ðŸ”Ž</span>
        <input id="searchBox" value="turkey" />
      </div>
    </div>

    <div class="menus">
      <div class="menu" data-menu="file">
        <button type="button">File</button>
        <div class="dropdown">
          <div class="item" id="exportPlan">
            <span>Export plan</span><span class="sub">.json</span>
          </div>
          <div class="item" id="importPlan">
            <span>Import plan</span><span class="sub">.json</span>
          </div>
          <div class="item" id="resetPlan">
            <span>Reset assignments</span><span class="sub">Danger</span>
          </div>
          <hr/>
          <div class="item" id="fitTurkey">
            <span>Fit Turkey</span><span class="sub">zoom</span>
          </div>
        </div>
      </div>

      <div class="menu" data-menu="tools">
        <button type="button">Tools</button>
        <div class="dropdown">
          <div class="item" id="undoBtn"><span>Undo</span><span class="sub">Ctrl+Z</span></div>
          <div class="item" id="redoBtn"><span>Redo</span><span class="sub">Ctrl+Y</span></div>
          <div class="item" style="cursor:default;">
            <span>Population year</span>
            <select id="yearSel" title="Population year">
              <option value="2024" selected>2024</option>
              <option value="2019">2019</option>
              <option value="2014">2014</option>
            </select>
          </div>
          <hr/>
          <div class="item" id="clearActive"><span>Unassign district</span><span class="sub">set to None</span></div>
        </div>
      </div>

      <div class="menu" data-menu="style">
        <button type="button">Map Style</button>
        <div class="dropdown">
          <div class="item" data-style="light"><span>Light basemap</span><span class="sub">default</span></div>
          <div class="item" data-style="dark"><span>Dark basemap</span><span class="sub">high contrast</span></div>
        </div>
      </div>

      <div class="menu" data-menu="advanced">
        <button type="button">Advanced</button>
        <div class="dropdown">
          <div class="item" id="togglePerf"><span>Prefer canvas renderer</span><span class="sub">faster</span></div>
          <div class="item" id="toggleAutosave"><span>Autosave</span><span class="sub">localStorage</span></div>
        </div>
      </div>

      <div class="menu" data-menu="help">
        <button type="button">Help</button>
        <div class="dropdown">
          <div class="item"><span>Controls</span><span class="sub">Click assigns</span></div>
          <div class="item"><span>Box tool</span><span class="sub">Hold Shift</span></div>
          <div class="item"><span>Unassign</span><span class="sub">Hold Alt</span></div>
        </div>
      </div>
    </div>

    <div class="top-right">
      <button class="iconbtn" id="userBtn" title="Profile (decorative)">ðŸ‘¤</button>
      <button class="iconbtn" id="themeBtn" title="Toggle UI tint (decorative)">ðŸŒ™</button>
    </div>
  </div>

  <div class="shell">
    <!-- Left panel -->
    <div class="panel">
      <div class="phead">
        <div class="title">Districts</div>
        <div class="badge" id="popBadge">â€”</div>
      </div>

      <div class="district-controls">
        <div class="dc-left">
          <span class="count">
            <button id="decK" title="Fewer districts">âˆ’</button>
            <span id="kVal">4</span>
            <button id="incK" title="More districts">+</button>
          </span>
          <span id="idealText">Ideal: â€”</span>
        </div>
        <div class="iconbtn" id="statsBtn" title="Stats (decorative)">ðŸ“Š</div>
      </div>

      <div class="toolrow">
        <select id="toolSel" title="Selection tool">
          <option value="click">Click</option>
          <option value="box">Box (shift)</option>
        </select>
      </div>

      <div class="pbody" style="padding:0;">
        <table>
          <thead>
            <tr><th>District</th><th>Population</th><th>Deviation</th></tr>
          </thead>
          <tbody id="districtRows"></tbody>
        </table>

        <div class="section">
          <h4>Map Settings</h4>

          <div class="tog">
            <label><input type="checkbox" id="optFill" checked /> Fill</label>
            <span class="muted" style="color:var(--muted2); font-weight:900; font-size:12px;">Districts</span>
          </div>
          <div class="tog">
            <label><input type="checkbox" id="optLines" checked /> Lines</label>
            <span class="muted" style="color:var(--muted2); font-weight:900; font-size:12px;">Districts</span>
          </div>
          <div class="tog">
            <label><input type="checkbox" id="optLabels" /> Labels</label>
            <span class="muted" style="color:var(--muted2); font-weight:900; font-size:12px;">Districts</span>
          </div>

          <div class="tog">
            <label><input type="checkbox" id="optHover" checked /> Highlight</label>
            <span class="muted" style="color:var(--muted2); font-weight:900; font-size:12px;">Hover</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle panel (active district data) -->
    <div class="panel">
      <div class="phead">
        <div class="title" id="midTitle">District 1</div>
        <div class="badge" id="midBadge">Active</div>
      </div>
      <div class="pbody">
        <button class="addbtn" type="button">+ Add more data</button>

        <div id="districtData"></div>
      </div>
    </div>

    <!-- Map -->
    <div class="mapwrap">
      <div class="maphud">
        <span class="small">Active:</span>
        <span class="chip" id="activeChip">District 1</span>
        <span class="small">â€¢ Click assigns â€¢ Shift+drag box â€¢ Alt unassign</span>
      </div>
      <div id="map"></div>
    </div>

    <!-- Right panel (hovered unit) -->
    <div class="panel rightpanel">
      <div class="phead">
        <div class="title" id="rightTitle">None</div>
        <div class="badge" id="rightBadge">No hovered block group</div>
      </div>
      <div class="pbody">
        <button class="addbtn" type="button">+ Add more data</button>
        <div id="hoverData"></div>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   Turkey Redistricter Replica (single-file)
   - Assign admin-level-6 districts (ilÃ§eler) into K user districts
   - Shows population + deviation, plus optional election aggregates
   Data files expected next to this HTML:
     - turkey-admin-level-6.geojson
     - province_district_2014_2019_2024.csv
     - Optional province election JSONs (e.g., Usak.json) in same folder
   ============================================================ */

const FILE_GEOJSON = "turkey-admin-level-6.geojson";
const FILE_POP_CSV = "province_district_2014_2019_2024.csv";
let activeYear = 2024;

// Province plate map (from your previous build)
const PLATE_TO_PROVINCE_TR = {
  1:"Adana",2:"AdÄ±yaman",3:"Afyonkarahisar",4:"AÄŸrÄ±",5:"Amasya",6:"Ankara",7:"Antalya",8:"Artvin",9:"AydÄ±n",10:"BalÄ±kesir",
  11:"Bilecik",12:"BingÃ¶l",13:"Bitlis",14:"Bolu",15:"Burdur",16:"Bursa",17:"Ã‡anakkale",18:"Ã‡ankÄ±rÄ±",19:"Ã‡orum",20:"Denizli",
  21:"DiyarbakÄ±r",22:"Edirne",23:"ElazÄ±ÄŸ",24:"Erzincan",25:"Erzurum",26:"EskiÅŸehir",27:"Gaziantep",28:"Giresun",29:"GÃ¼mÃ¼ÅŸhane",30:"HakkÃ¢ri",
  31:"Hatay",32:"Isparta",33:"Mersin",34:"Ä°stanbul",35:"Ä°zmir",36:"Kars",37:"Kastamonu",38:"Kayseri",39:"KÄ±rklareli",40:"KÄ±rÅŸehir",
  41:"Kocaeli",42:"Konya",43:"KÃ¼tahya",44:"Malatya",45:"Manisa",46:"KahramanmaraÅŸ",47:"Mardin",48:"MuÄŸla",49:"MuÅŸ",50:"NevÅŸehir",
  51:"NiÄŸde",52:"Ordu",53:"Rize",54:"Sakarya",55:"Samsun",56:"Siirt",57:"Sinop",58:"Sivas",59:"TekirdaÄŸ",60:"Tokat",
  61:"Trabzon",62:"Tunceli",63:"ÅžanlÄ±urfa",64:"UÅŸak",65:"Van",66:"Yozgat",67:"Zonguldak",68:"Aksaray",69:"Bayburt",70:"Karaman",
  71:"KÄ±rÄ±kkale",72:"Batman",73:"ÅžÄ±rnak",74:"BartÄ±n",75:"Ardahan",76:"IÄŸdÄ±r",77:"Yalova",78:"KarabÃ¼k",79:"Kilis",80:"Osmaniye",81:"DÃ¼zce"
};

const TR_CHARMAP = {"Ä°":"I","I":"I","Ä±":"i","Åž":"S","ÅŸ":"s","Äž":"G","ÄŸ":"g","Ãœ":"U","Ã¼":"u","Ã–":"O","Ã¶":"o","Ã‡":"C","Ã§":"c","Ã‚":"A","Ã¢":"a","ÃŽ":"I","Ã®":"i","Ã›":"U","Ã»":"u"};
function foldTR(str){
  const s = (str ?? "").toString().replace(/[Ä°IÄ±ÅžÅŸÄžÄŸÃœÃ¼Ã–Ã¶Ã‡Ã§Ã‚Ã¢ÃŽÃ®Ã›Ã»]/g, ch => TR_CHARMAP[ch] || ch);
  return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}
function keyify(str){
  return foldTR(str).toLowerCase().replace(/[^a-z0-9]+/g," ").trim().replace(/\s+/g,"-");
}
function cleanLabel(str){ return (str ?? "").toString().replace(/\s+/g," ").trim(); }
function fmtInt(n){ return Number.isFinite(n) ? Math.round(n).toLocaleString("tr-TR") : "â€”"; }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

/* ---- smart path fetch (kept from your old build) ---- */
function repoBasePath(){
  const parts = window.location.pathname.split("/").filter(Boolean);
  if (window.location.hostname.endsWith("github.io") && parts.length >= 1) return "/" + parts[0] + "/";
  return "/";
}
function currentDirUrl(){
  const u = new URL(window.location.href);
  u.hash=""; u.search="";
  if (!u.pathname.endsWith("/")) u.pathname = u.pathname.substring(0, u.pathname.lastIndexOf("/")+1);
  return u.toString();
}
function buildCandidates(file){
  const baseRepo = repoBasePath();
  const here = currentDirUrl();
  const uHere = new URL(file, here).toString();
  const uUp1  = new URL("../"+file, here).toString();
  const uUp2  = new URL("../../"+file, here).toString();
  const uRepoRoot = new URL(file.replace(/^\.\//,""), window.location.origin + baseRepo).toString();
  const uRepoDocs = new URL("docs/"+file.replace(/^\.\//,""), window.location.origin + baseRepo).toString();
  const out=[]; const seen=new Set();
  for (const u of [uHere,uRepoRoot,uRepoDocs,uUp1,uUp2]){ if(!seen.has(u)){ seen.add(u); out.push(u); } }
  return out;
}
async function fetchFirstOk(file, asJson){
  const candidates = buildCandidates(file);
  let lastErr = null;
  for (const url of candidates){
    try{
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok){ lastErr = `HTTP ${res.status} ${res.statusText}`; continue; }
      return asJson ? await res.json() : await res.text();
    }catch(e){ lastErr = "Network/CORS"; }
  }
  throw new Error(`Failed to fetch "${file}". Tried:\n- ${candidates.join("\n- ")}\nLast: ${lastErr}`);
}

// Lighter-weight "maybe" fetch (2 candidates only) for optional files like province JSONs
async function fetchMaybeJson(file){
  const here = currentDirUrl();
  const baseRepo = repoBasePath();
  const urls = [
    new URL(file, here).toString(),
    new URL(file, window.location.origin + baseRepo).toString()
  ];
  for (const url of urls){
    try{
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) continue;
      return await res.json();
    }catch(_e){}
  }
  throw new Error("Missing optional file: " + file);
}

/* ---- Number parsing for election JSONs ---- */
function parseTrNumber(x){
  if (x === null || x === undefined) return null;
  let s = String(x).trim();
  if (!s) return null;
  s = s.replace(/\s+/g,"").replace(/%/g,"");
  if (s.includes(".") && s.includes(",")) s = s.replace(/\./g,"").replace(/,/g,".");
  else if (s.includes(".")){
    const parts = s.split(".");
    if (parts.length > 2) s = parts.join("");
    else if (parts.length === 2 && parts[1].length === 3) s = parts.join("");
  } else if (s.includes(",")){
    const parts = s.split(",");
    if (parts.length === 2 && parts[1].length !== 3) s = parts.join(".");
    else s = parts.join("");
  }
  s = s.replace(/[^0-9.\-]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

/* ============================================================
   DATA STORES
   ============================================================ */
const popByKey = new Map();      // "plate:districtKey" -> {2014,2019,2024}
const electionByKey = new Map(); // "plate:districtKey" -> {registered, cast, valid, votes:Map, winner, margin}
let allFeatures = [];            // cached features for search
let turkeyBounds = null;

/* ============================================================
   DISTRICTING STATE
   ============================================================ */
let K = 4;
let activeDistrict = 1; // 1..K, 0 = None/unassigned
const assignments = new Map();   // featureKey -> districtId

// history (undo/redo)
let autosave = true;
const HISTORY_MAX = 60;
let undoStack = [];
let redoStack = [];

function pushHistory(patch){
  undoStack.push(patch);
  if (undoStack.length > HISTORY_MAX) undoStack.shift();
  redoStack = [];
  if (autosave) savePlan();
}

function applyPatch(patch, dir){
  // dir = +1 means redo (apply "to"), dir = -1 means undo (apply "from")
  for (const p of patch){
    assignments.set(p.key, dir>0 ? p.to : p.from);
  }
}

function savePlan(){
  try{
    const obj = { v:1, K, activeYear, assignments: Object.fromEntries(assignments.entries()) };
    localStorage.setItem("tr-redistricter_plan_v1", JSON.stringify(obj));
  }catch(_e){}
}
function loadPlan(){
  try{
    const raw = localStorage.getItem("tr-redistricter_plan_v1");
    if (!raw) return false;
    const obj = JSON.parse(raw);
    if (!obj || obj.v !== 1) return false;
    if (Number.isFinite(obj.K)) K = clamp(obj.K, 1, 60);
    if (Number.isFinite(obj.activeYear)) activeYear = obj.activeYear;
    const a = obj.assignments || {};
    for (const [k,v] of Object.entries(a)){
      const dv = Number(v);
      if (Number.isFinite(dv)) assignments.set(k, clamp(dv, 0, K));
    }
    return true;
  }catch(_e){ return false; }
}

/* ============================================================
   COLORS
   ============================================================ */
const DISTRICT_PALETTE = [
  "#60a5fa", "#f87171", "#34d399", "#fbbf24", "#a78bfa", "#fb7185",
  "#22c55e", "#f97316", "#38bdf8", "#e879f9", "#c084fc", "#facc15"
];
function districtColor(id){
  if (id<=0) return "#3b4252";
  const base = DISTRICT_PALETTE[(id-1) % DISTRICT_PALETTE.length];
  return base;
}
function mix(hexA, hexB, t){
  const a = hexToRgb(hexA), b = hexToRgb(hexB);
  const r = Math.round(a.r + (b.r-a.r)*t);
  const g = Math.round(a.g + (b.g-a.g)*t);
  const bl = Math.round(a.b + (b.b-a.b)*t);
  return rgbToHex({r,g,b:bl});
}
function hexToRgb(hex){
  const h = hex.replace("#","").trim();
  const full = (h.length===3) ? h.split("").map(c=>c+c).join("") : h;
  const n = parseInt(full,16);
  return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
}
function rgbToHex({r,g,b}){
  const to = v => v.toString(16).padStart(2,"0");
  return "#" + to(r) + to(g) + to(b);
}

/* ============================================================
   MAP INIT
   ============================================================ */
let useCanvas = true;
const map = L.map("map", { zoomControl:true, preferCanvas: true, zoomSnap: 0.25 });
let tileMode = "light";
let baseTiles = null;
let geoLayer = null;
let labelLayer = L.layerGroup().addTo(map);
let hoverKey = null;

function setTiles(mode){
  tileMode = mode;
  if (baseTiles) baseTiles.remove();
  if (mode === "dark"){
    baseTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      maxZoom: 18
    }).addTo(map);
  } else {
    baseTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      maxZoom: 18
    }).addTo(map);
  }
}
setTiles("light");
map.setView([39.0, 35.0], 6);

function hardInvalidate(){ try{ map.invalidateSize(true); }catch{} }
window.addEventListener("resize", () => setTimeout(hardInvalidate, 0));
setTimeout(hardInvalidate, 0);

/* ============================================================
   FEATURE KEYS
   ============================================================ */
function featurePlate(feature){
  const net = feature?.properties?.network || "";
  const m = String(net).match(/TR(\d+)/i);
  return m ? Number(m[1]) : null;
}
function featureKey(feature){
  const plate = featurePlate(feature);
  const dist = feature?.properties?.name || "";
  return (plate ?? "null") + ":" + keyify(dist);
}
function provinceNameFromPlate(plate){
  return PLATE_TO_PROVINCE_TR[plate] || ("Plate " + plate);
}
function tooltipHtml(feature){
  const plate = featurePlate(feature);
  const prov = plate ? provinceNameFromPlate(plate) : "Unknown";
  const dist = feature?.properties?.name || "â€”";
  const key = featureKey(feature);
  const pop = popByKey.get(key)?.[String(activeYear)];
  const did = assignments.get(key) ?? 0;
  const dname = did === 0 ? "None" : ("District " + did);
  return `<div style="font-weight:1000">${dist}</div><div style="margin-top:2px;color:#9ca3af;font-weight:900;font-size:12px">${prov} â€¢ ${fmtInt(pop)} â€¢ ${dname}</div>`;
}

/* ============================================================
   STYLES
   ============================================================ */
function baseStyle(feature){
  const key = featureKey(feature);
  const did = assignments.get(key) ?? 0;

  const fillOn = document.getElementById("optFill").checked;
  const linesOn = document.getElementById("optLines").checked;

  const base = districtColor(did);
  const active = (did === activeDistrict && did !== 0);
  const fillColor = active ? mix(base, "#ffffff", 0.22) : mix(base, "#000000", 0.06);

  return {
    color: linesOn ? (active ? "#e5e7eb" : "#111827") : "transparent",
    weight: linesOn ? (active ? 2.2 : 1.1) : 0,
    opacity: linesOn ? 0.95 : 0,
    fillColor: fillOn ? fillColor : "transparent",
    fillOpacity: fillOn ? (did===0 ? 0.32 : 0.62) : 0,
    lineJoin: "round"
  };
}
function hoverStyle(feature){
  const linesOn = document.getElementById("optLines").checked;
  return { color: linesOn ? "#60a5fa" : "transparent", weight: linesOn ? 2.6 : 0, opacity: 1, fillOpacity: 0.80 };
}
function selectedStyle(feature){
  const linesOn = document.getElementById("optLines").checked;
  return { color: linesOn ? "#0ea5e9" : "transparent", weight: linesOn ? 3.0 : 0, opacity: 1, fillOpacity: 0.84 };
}

/* ============================================================
   AGGREGATION
   ============================================================ */
function totalPopulation(){
  let sum = 0;
  for (const f of allFeatures){
    const key = featureKey(f);
    const p = popByKey.get(key)?.[String(activeYear)];
    if (Number.isFinite(p)) sum += p;
  }
  return sum;
}
function districtStats(){
  const totals = Array.from({length: K+1}, () => ({ pop:0, voteSum:new Map(), reg:0, cast:0, valid:0, n:0 }));
  for (const f of allFeatures){
    const key = featureKey(f);
    const did = assignments.get(key) ?? 0;
    const p = popByKey.get(key)?.[String(activeYear)];
    if (Number.isFinite(p)) totals[did].pop += p;
    totals[did].n++;

    const e = electionByKey.get(key);
    if (e){
      if (Number.isFinite(e.registered)) totals[did].reg += e.registered;
      if (Number.isFinite(e.cast)) totals[did].cast += e.cast;
      if (Number.isFinite(e.valid)) totals[did].valid += e.valid;
      if (e.votes){
        for (const [party,v] of e.votes.entries()){
          totals[did].voteSum.set(party, (totals[did].voteSum.get(party) || 0) + v);
        }
      }
    }
  }
  const totPop = totalPopulation();
  const ideal = (K > 0) ? totPop / K : 0;
  const rows = totals.map((t, idx) => ({
    id: idx,
    pop: t.pop,
    dev: idx === 0 ? (ideal - t.pop) : (t.pop - ideal),
    turnout: (t.reg>0 && t.cast>=0) ? (t.cast/t.reg) : null,
    votes: t.voteSum,
    reg: t.reg, cast: t.cast, valid: t.valid
  }));
  return { rows, ideal, total: totPop };
}

/* ============================================================
   UI RENDERING
   ============================================================ */
const elRows = document.getElementById("districtRows");
const elKVal = document.getElementById("kVal");
const elIdeal = document.getElementById("idealText");
const elPopBadge = document.getElementById("popBadge");
const elActiveChip = document.getElementById("activeChip");
const elMidTitle = document.getElementById("midTitle");
const elDistrictData = document.getElementById("districtData");

const elRightTitle = document.getElementById("rightTitle");
const elRightBadge = document.getElementById("rightBadge");
const elHoverData = document.getElementById("hoverData");

function renderDistrictTable(){
  const { rows, ideal, total } = districtStats();

  elKVal.textContent = String(K);
  elIdeal.textContent = "Ideal: " + fmtInt(ideal);
  elPopBadge.textContent = "Pop: " + fmtInt(total);

  elActiveChip.textContent = activeDistrict === 0 ? "None" : ("District " + activeDistrict);
  elMidTitle.textContent = activeDistrict === 0 ? "None" : ("District " + activeDistrict);

  elRows.innerHTML = "";

  // "None" row first (id=0)
  for (const r of rows){
    const tr = document.createElement("tr");
    if (r.id === activeDistrict) tr.classList.add("active");

    const sw = document.createElement("span");
    sw.className = "sw";
    sw.style.background = districtColor(r.id);

    const distCell = document.createElement("td");
    const pill = document.createElement("span");
    pill.className = "pill";
    pill.appendChild(sw);
    pill.appendChild(document.createTextNode(r.id === 0 ? "None" : String(r.id)));
    distCell.appendChild(pill);

    const popCell = document.createElement("td");
    popCell.textContent = fmtInt(r.pop);

    const devCell = document.createElement("td");
    if (!Number.isFinite(r.dev)){
      devCell.textContent = "â€”";
      devCell.className = "devna";
    } else {
      const v = Math.round(r.dev);
      const s = (v>=0? "+" : "âˆ’") + fmtInt(Math.abs(v));
      devCell.textContent = s;
      devCell.className = (v>=0 ? "devpos" : "devneg");
    }

    tr.appendChild(distCell);
    tr.appendChild(popCell);
    tr.appendChild(devCell);

    tr.addEventListener("click", () => {
      activeDistrict = r.id;
      renderDistrictTable();
      renderActiveDistrictPanel();
      refreshStyles();
      renderLabels();
    });

    elRows.appendChild(tr);
  }
}

function mkCard(title, rightText, dotColor, bodyBuilder){
  const card = document.createElement("div");
  card.className = "datacard open";

  const head = document.createElement("div");
  head.className = "dhead";

  const left = document.createElement("div");
  left.className = "left";
  const dot = document.createElement("div");
  dot.className = "dot";
  dot.style.background = dotColor || "rgba(255,255,255,.25)";
  left.appendChild(dot);
  left.appendChild(document.createTextNode(title));

  const right = document.createElement("div");
  right.className = "right";
  const val = document.createElement("span");
  val.textContent = rightText ?? "";
  right.appendChild(val);

  const mini = document.createElement("button");
  mini.className = "mini";
  mini.type = "button";
  mini.textContent = "â–¾";
  mini.title = "Collapse";
  mini.addEventListener("click", (e) => {
    e.stopPropagation();
    card.classList.toggle("open");
    mini.textContent = card.classList.contains("open") ? "â–¾" : "â–¸";
  });
  right.appendChild(mini);

  head.appendChild(left);
  head.appendChild(right);
  card.appendChild(head);

  const body = document.createElement("div");
  body.className = "dbody";
  bodyBuilder(body);
  card.appendChild(body);

  // click header toggles too
  head.addEventListener("click", () => mini.click());

  return card;
}

function renderActiveDistrictPanel(){
  const { rows, ideal } = districtStats();
  const r = rows.find(x => x.id === activeDistrict) || rows[0];

  elDistrictData.innerHTML = "";
  const color = districtColor(activeDistrict);

  // Population
  elDistrictData.appendChild(mkCard(
    "Population (" + activeYear + ")",
    fmtInt(r.pop),
    color,
    (body) => {
      body.appendChild(kv("Ideal", fmtInt(ideal)));
      body.appendChild(kv("Deviation", (r.dev>=0? "+" : "âˆ’") + fmtInt(Math.abs(r.dev))));
      body.appendChild(kv("Units", fmtInt(r.units)));
    }
  ));

  // Turnout (if we have election numbers)
  const turnoutTxt = (r.turnout !== null && Number.isFinite(r.turnout)) ? (r.turnout*100).toFixed(2).replace(".",",") + "%" : "N/A";
  elDistrictData.appendChild(mkCard(
    "Turnout",
    turnoutTxt,
    "#22c55e",
    (body) => {
      body.appendChild(kv("Registered", fmtInt(r.reg)));
      body.appendChild(kv("Cast", fmtInt(r.cast)));
      body.appendChild(kv("Valid", fmtInt(r.valid)));
    }
  ));

  // Election (top parties)
  elDistrictData.appendChild(mkCard(
    "Election (aggregated)",
    (r.votes && r.votes.size) ? (topParty(r.votes)?.name || "â€”") : "N/A",
    "#f59e0b",
    (body) => {
      if (!r.votes || r.votes.size === 0){
        body.appendChild(kv("Data", "No province election JSON found"));
        body.appendChild(kv("Tip", "Drop province JSONs next to this HTML"));
        return;
      }
      const totalVotes = [...r.votes.values()].reduce((s,v)=>s+v,0);
      body.appendChild(kv("Votes (sum)", fmtInt(totalVotes)));
      const top = [...r.votes.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);

      const bars = document.createElement("div");
      bars.className = "bars";
      for (const [p,v] of top){
        const pct = totalVotes>0 ? (v/totalVotes) : 0;
        const wrap = document.createElement("div");

        const lab = document.createElement("div");
        lab.className = "lab";
        const sw = document.createElement("span");
        sw.className = "sw";
        sw.style.background = hashColor(p);
        lab.appendChild(sw);
        lab.appendChild(document.createTextNode(cleanLabel(p)));

        const track = document.createElement("div");
        track.className = "track";
        const fill = document.createElement("div");
        fill.className = "fill";
        fill.style.width = (pct*100).toFixed(1) + "%";
        fill.style.background = mix(hashColor(p), "#ffffff", 0.15);
        track.appendChild(fill);

        const row = document.createElement("div");
        row.className = "bar";
        const left = document.createElement("div");
        left.appendChild(lab);
        left.appendChild(track);

        const val = document.createElement("div");
        val.className = "val";
        val.textContent = fmtInt(v) + " (" + (pct*100).toFixed(2).replace(".",",") + "%)";

        row.appendChild(left);
        row.appendChild(val);
        bars.appendChild(row);
      }
      body.appendChild(bars);
    }
  ));
}

function kv(k,v){
  const row = document.createElement("div");
  row.className = "kv";
  const a = document.createElement("div");
  a.className = "k";
  a.textContent = k;
  const b = document.createElement("div");
  b.className = "v";
  b.textContent = (v ?? "â€”");
  row.appendChild(a);
  row.appendChild(b);
  return row;
}

function hashColor(s){
  const k = keyify(s);
  let h = 0;
  for (let i=0;i<k.length;i++) h = (h*31 + k.charCodeAt(i)) >>> 0;
  const palette = ["#60a5fa","#f87171","#34d399","#fbbf24","#a78bfa","#fb7185","#22c55e","#f97316"];
  return palette[h % palette.length];
}
function topParty(voteMap){
  const sorted = [...voteMap.entries()].sort((a,b)=>b[1]-a[1]);
  if (!sorted.length) return null;
  return { name: sorted[0][0], votes: sorted[0][1] };
}

function renderHoverPanel(feature){
  if (!feature){
    elRightTitle.textContent = "None";
    elRightBadge.textContent = "No hovered block group";
    elHoverData.innerHTML = "";
    return;
  }
  const key = featureKey(feature);
  const plate = featurePlate(feature);
  const prov = plate ? provinceNameFromPlate(plate) : "Unknown";
  const name = feature?.properties?.name || "â€”";
  const did = assignments.get(key) ?? 0;
  const pop = popByKey.get(key)?.[String(activeYear)];
  const elec = electionByKey.get(key);

  elRightTitle.textContent = name;
  elRightBadge.textContent = prov + " â€¢ " + (did===0 ? "None" : ("District " + did));
  elHoverData.innerHTML = "";

  elHoverData.appendChild(mkCard(
    "Population (" + activeYear + ")",
    fmtInt(pop),
    districtColor(did),
    (body) => {
      body.appendChild(kv("Province", prov));
      body.appendChild(kv("Assigned to", did===0 ? "None" : ("District " + did)));
      body.appendChild(kv("Key", key));
    }
  ));

  const turnout = (elec?.registered>0 && elec?.cast>=0) ? (elec.cast/elec.registered) : null;
  elHoverData.appendChild(mkCard(
    "Turnout",
    (turnout!==null && Number.isFinite(turnout)) ? (turnout*100).toFixed(2).replace(".",",")+"%" : "N/A",
    "#22c55e",
    (body) => {
      body.appendChild(kv("Registered", fmtInt(elec?.registered)));
      body.appendChild(kv("Cast", fmtInt(elec?.cast)));
      body.appendChild(kv("Valid", fmtInt(elec?.valid)));
    }
  ));

  elHoverData.appendChild(mkCard(
    "Election (top)",
    elec?.winner ? cleanLabel(elec.winner) : "N/A",
    "#f59e0b",
    (body) => {
      if (!elec || !elec.votes || elec.votes.size===0){
        body.appendChild(kv("Data", "N/A"));
        return;
      }
      const totalVotes = [...elec.votes.values()].reduce((s,v)=>s+v,0);
      const top = [...elec.votes.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
      body.appendChild(kv("Votes (sum)", fmtInt(totalVotes)));
      for (const [p,v] of top){
        body.appendChild(kv(cleanLabel(p), fmtInt(v)));
      }
    }
  ));
}

/* ============================================================
   LABELS (district numbers)
   ============================================================ */
function centroidOfBounds(bounds){
  const c = bounds.getCenter();
  return [c.lat, c.lng];
}
function renderLabels(){
  labelLayer.clearLayers();
  if (!document.getElementById("optLabels").checked) return;

  // compute bounds per district id (excluding None)
  const b = new Map();
  geoLayer.eachLayer(layer => {
    const key = featureKey(layer.feature);
    const did = assignments.get(key) ?? 0;
    if (did <= 0) return;
    const bb = layer.getBounds();
    if (!b.has(did)) b.set(did, bb);
    else b.get(did).extend(bb);
  });

  for (const [did, bounds] of b.entries()){
    const c = centroidOfBounds(bounds);
    const icon = L.divIcon({
      className: "",
      html: `<div style="
        width:28px;height:28px;border-radius:12px;
        display:grid;place-items:center;
        background: rgba(0,0,0,.55);
        border:1px solid rgba(255,255,255,.14);
        color:#e5e7eb;
        font-weight:1000;
        box-shadow: 0 10px 28px rgba(0,0,0,.35);
      ">${did}</div>`,
      iconSize: [28,28],
      iconAnchor: [14,14]
    });
    L.marker(c, { icon, interactive:false }).addTo(labelLayer);
  }
}

/* ============================================================
   MAP LAYER: draw + events
   ============================================================ */
let lastHoverLayer = null;

function drawGeo(gj){
  if (geoLayer) geoLayer.remove();

  const renderer = useCanvas ? L.canvas({ padding: 0.5 }) : undefined;

  geoLayer = L.geoJSON(gj, {
    renderer,
    filter: (feature) => {
      const t = feature?.geometry?.type;
      return t === "Polygon" || t === "MultiPolygon";
    },
    style: baseStyle,
    onEachFeature: (feature, layer) => {
      assignments.set(featureKey(feature), assignments.get(featureKey(feature)) ?? 0);
      layer.bindTooltip(tooltipHtml(feature), { sticky:true, direction:"auto" });

      layer.on("mouseover", () => {
        if (!document.getElementById("optHover").checked) return;
        const key = featureKey(feature);
        hoverKey = key;
        if (lastHoverLayer && lastHoverLayer !== layer) geoLayer.resetStyle(lastHoverLayer);
        lastHoverLayer = layer;
        layer.setStyle(hoverStyle(feature));
        renderHoverPanel(feature);
      });

      layer.on("mouseout", () => {
        if (!document.getElementById("optHover").checked) return;
        if (lastHoverLayer){
          geoLayer.resetStyle(lastHoverLayer);
          lastHoverLayer = null;
        }
        hoverKey = null;
        renderHoverPanel(null);
      });

      layer.on("click", (e) => {
        // click assigns unless box tool is active AND shift is pressed (box handles)
        if (document.getElementById("toolSel").value === "box" && e.originalEvent.shiftKey) return;
        const unassign = e.originalEvent.altKey;
        assignKeys([featureKey(feature)], unassign ? 0 : activeDistrict);
      });
    }
  }).addTo(map);

  allFeatures = gj.features || [];
  turkeyBounds = geoLayer.getBounds();
  map.fitBounds(turkeyBounds, { padding:[20,20] });
  hardInvalidate();
  refreshStyles();
  renderLabels();
}

function refreshStyles(){
  if (!geoLayer) return;
  geoLayer.setStyle(baseStyle);
}

/* ============================================================
   ASSIGNMENTS
   ============================================================ */
function assignKeys(keys, toDistrict){
  const patch = [];
  for (const key of keys){
    const from = assignments.get(key) ?? 0;
    const to = clamp(toDistrict, 0, K);
    if (from === to) continue;
    patch.push({ key, from, to });
    assignments.set(key, to);
  }
  if (!patch.length) return;

  pushHistory(patch);

  // update visuals (re-style only affected layers)
  geoLayer.eachLayer(layer => {
    const k = featureKey(layer.feature);
    if (patch.some(p => p.key === k)){
      layer.setStyle(baseStyle(layer.feature));
      // tooltip is data-dependent
      layer.setTooltipContent(tooltipHtml(layer.feature));
    }
  });

  renderDistrictTable();
  renderActiveDistrictPanel();
  renderLabels();
}

function unassignDistrict(did){
  const keys = [];
  geoLayer.eachLayer(layer => {
    const k = featureKey(layer.feature);
    if ((assignments.get(k) ?? 0) === did) keys.push(k);
  });
  assignKeys(keys, 0);
}

/* ============================================================
   BOX SELECTION (Shift+drag)
   ============================================================ */
let boxActive = false;
let boxStart = null;
let boxRect = null;

map.on("mousedown", (e) => {
  const tool = document.getElementById("toolSel").value;
  if (tool !== "box") return;
  if (!e.originalEvent.shiftKey) return;

  boxActive = true;
  boxStart = e.latlng;
  map.dragging.disable();
  map.boxZoom.disable();

  if (boxRect) boxRect.remove();
  boxRect = L.rectangle([boxStart, boxStart], {
    color: "#60a5fa",
    weight: 2,
    fillColor: "#60a5fa",
    fillOpacity: 0.12,
    dashArray: "6,6"
  }).addTo(map);
});

map.on("mousemove", (e) => {
  if (!boxActive || !boxRect) return;
  boxRect.setBounds(L.latLngBounds(boxStart, e.latlng));
});

map.on("mouseup", (e) => {
  if (!boxActive) return;
  boxActive = false;
  map.dragging.enable();

  if (!boxRect) return;
  const bounds = boxRect.getBounds();
  boxRect.remove();
  boxRect = null;

  const keys = [];
  geoLayer.eachLayer(layer => {
    const lb = layer.getBounds();
    if (bounds.intersects(lb)) keys.push(featureKey(layer.feature));
  });

  const unassign = e.originalEvent.altKey;
  assignKeys(keys, unassign ? 0 : activeDistrict);
});

/* ============================================================
   POP CSV
   ============================================================ */
function parsePopulationCsv(txt){
  const lines = txt.trim().split(/\r?\n/);
  if (lines.length < 2) return;

  const header = lines[0].split(",").map(h=>h.trim());
  const idx = {
    province: header.indexOf("Province"),
    district: header.indexOf("District"),
    y2014: header.indexOf("2014"),
    y2019: header.indexOf("2019"),
    y2024: header.indexOf("2024")
  };

  const provinceToPlate = new Map();
  for (const [plateStr, trName] of Object.entries(PLATE_TO_PROVINCE_TR)){
    const plate = Number(plateStr);
    provinceToPlate.set(keyify(trName), plate);
    provinceToPlate.set(keyify(foldTR(trName)), plate);
  }
  // a few common ASCII variants
  provinceToPlate.set(keyify("Sanliurfa"), 63);
  provinceToPlate.set(keyify("Kahramanmaras"), 46);
  provinceToPlate.set(keyify("Igdir"), 76);
  provinceToPlate.set(keyify("Kirikkale"), 71);
  provinceToPlate.set(keyify("Kirsehir"), 40);

  for (let i=1;i<lines.length;i++){
    const row = lines[i].split(",");
    const prov = row[idx.province]?.trim();
    const dist = row[idx.district]?.trim();
    if (!prov || !dist) continue;

    const plate = provinceToPlate.get(keyify(prov));
    if (!plate) continue;

    const key = plate + ":" + keyify(dist);
    const y2014 = Number(row[idx.y2014]);
    const y2019 = Number(row[idx.y2019]);
    const y2024 = Number(row[idx.y2024]);

    popByKey.set(key, {
      2014: Number.isFinite(y2014) ? y2014 : null,
      2019: Number.isFinite(y2019) ? y2019 : null,
      2024: Number.isFinite(y2024) ? y2024 : null
    });
  }
}

/* ============================================================
   OPTIONAL ELECTION JSON LOAD
   - tries 81 province files like "Usak.json" etc
   ============================================================ */
function provinceFileName(trName){
  const folded = foldTR(trName).toLowerCase().replace(/[^a-z0-9]/g,"");
  return folded ? (folded[0].toUpperCase() + folded.slice(1)) : "Province";
}
const PROVINCE_FILES = Object.entries(PLATE_TO_PROVINCE_TR).map(([plate,tr]) => ({
  plate: Number(plate),
  file: provinceFileName(tr) + ".json"
}));

async function loadElectionAllProvincesLimited(limit){
  let loaded = 0;
  let i = 0;
  async function worker(){
    while (i < PROVINCE_FILES.length){
      const mine = i++;
      const p = PROVINCE_FILES[mine];
      try{
        const json = await fetchMaybeJson(p.file);
        parseProvinceElectionJson(p.plate, json);
        loaded++;
      }catch(_e){
        // ignore missing province files
      }
    }
  }
  await Promise.all(Array.from({length:limit}, () => worker()));
  return loaded;
}

function getField(row, names){
  for (const n of names){
    if (row && Object.prototype.hasOwnProperty.call(row, n)) return row[n];
  }
  return undefined;
}

function parseProvinceElectionJson(plate, json){
  if (!Array.isArray(json)) return;
  for (const row of json){
    const ilceId  = getField(row, ["Ilce Id","Ä°lce Id","Ä°lÃ§e Id","Ä°lÃ§e Id ","IlceId","Ä°lÃ§eId"]);
    const ilceAdi = getField(row, ["Ilce Adi","Ä°lÃ§e AdÄ±","Ilce AdÄ±","Ä°lÃ§e Adi","IlceAdi","Ä°lÃ§eAdÄ±","Ä°lÃ§e Adi "]);

    const idStr = cleanLabel(ilceId);
    const nameStr = cleanLabel(ilceAdi);
    if (!nameStr) continue;

    // skip header/percent rows
    if (!idStr || keyify(idStr) === "oy-orani") continue;
    const idDigits = foldTR(idStr).replace(/\D/g,"");
    if (!idDigits || !/^\d+$/.test(idDigits)) continue;

    const registered = parseTrNumber(getField(row, ["Kayitli Secmen Sayisi","KayÄ±tlÄ± SeÃ§men SayÄ±sÄ±","KayitliSecmenSayisi","KayÄ±tlÄ±SeÃ§menSayÄ±sÄ±"]));
    const cast      = parseTrNumber(getField(row, ["Oy Kullanan Secmen Sayisi","Oy Kullanan SeÃ§men SayÄ±sÄ±","OyKullananSecmenSayisi"]));
    const valid     = parseTrNumber(getField(row, ["Gecerli Oy Toplami","GeÃ§erli Oy ToplamÄ±","GecerliOyToplami"]));

    const votes = new Map();
    const skipKeys = new Set([
      "Ilce Id","Ä°lce Id","Ä°lÃ§e Id","Ä°lÃ§e Id ","IlceId","Ä°lÃ§eId",
      "Ilce Adi","Ä°lÃ§e AdÄ±","Ilce AdÄ±","Ä°lÃ§e Adi","IlceAdi","Ä°lÃ§eAdÄ±","Ä°lÃ§e Adi ",
      "Belde Adi","Belde AdÄ±",
      "Kayitli Secmen Sayisi","KayÄ±tlÄ± SeÃ§men SayÄ±sÄ±","KayitliSecmenSayisi","KayÄ±tlÄ±SeÃ§menSayÄ±sÄ±",
      "Oy Kullanan Secmen Sayisi","Oy Kullanan SeÃ§men SayÄ±sÄ±","OyKullananSecmenSayisi",
      "Gecerli Oy Toplami","GeÃ§erli Oy ToplamÄ±","GecerliOyToplami"
    ]);

    for (const [k,v] of Object.entries(row)){
      if (skipKeys.has(k)) continue;
      const kk = cleanLabel(k);
      if (!kk) continue;
      if (keyify(kk) === "oy-orani") continue;

      const n = parseTrNumber(v);
      if (!Number.isFinite(n) || n <= 0) continue;
      votes.set(kk, n);
    }

    const sorted = [...votes.entries()].sort((a,b)=>b[1]-a[1]);
    const winner = sorted[0]?.[0] ?? null;
    const winnerVotes = sorted[0]?.[1] ?? null;
    const runnerVotes = sorted[1]?.[1] ?? null;

    const denom = (Number.isFinite(valid) && valid>0) ? valid :
      (sorted.reduce((s,[_p,val])=>s+val,0) || null);

    const margin = (Number.isFinite(winnerVotes) && Number.isFinite(runnerVotes) && Number.isFinite(denom) && denom>0)
      ? (winnerVotes-runnerVotes)/denom
      : null;

    const key = plate + ":" + keyify(nameStr);
    electionByKey.set(key, { plate, districtNameRaw:nameStr, registered, cast, valid, denom, votes, winner, margin });
  }
}

/* ============================================================
   MENUS + HOTKEYS
   ============================================================ */
function closeAllMenus(){
  document.querySelectorAll(".dropdown").forEach(d => d.style.display = "none");
}
document.addEventListener("click", (e) => {
  const m = e.target.closest(".menu");
  if (!m) closeAllMenus();
});
document.querySelectorAll(".menu").forEach(m => {
  const btn = m.querySelector("button");
  const dd = m.querySelector(".dropdown");
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dd.style.display === "block";
    closeAllMenus();
    dd.style.display = open ? "none" : "block";
  });
});

// File actions
document.getElementById("fitTurkey").addEventListener("click", () => {
  closeAllMenus();
  if (turkeyBounds) map.fitBounds(turkeyBounds, { padding:[20,20] });
});
document.getElementById("resetPlan").addEventListener("click", () => {
  closeAllMenus();
  if (!confirm("Reset all assignments?")) return;
  const keys = [...assignments.keys()];
  assignKeys(keys, 0);
});
document.getElementById("exportPlan").addEventListener("click", () => {
  closeAllMenus();
  const obj = { v:1, K, activeYear, assignments: Object.fromEntries(assignments.entries()) };
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "turkey_plan.json";
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById("importPlan").addEventListener("click", async () => {
  closeAllMenus();
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const f = inp.files?.[0];
    if (!f) return;
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if (!obj || obj.v !== 1 || !obj.assignments) return alert("Invalid plan file.");
    K = clamp(Number(obj.K || K), 1, 60);
    activeYear = Number(obj.activeYear || activeYear);
    assignments.clear();
    for (const [k,v] of Object.entries(obj.assignments)){
      assignments.set(k, clamp(Number(v), 0, K));
    }
    undoStack = []; redoStack = [];
    renderDistrictTable();
    renderActiveDistrictPanel();
    refreshStyles();
    renderLabels();
    if (autosave) savePlan();
  };
  inp.click();
});

// Tools actions
document.getElementById("undoBtn").addEventListener("click", () => { closeAllMenus(); undo(); });
document.getElementById("redoBtn").addEventListener("click", () => { closeAllMenus(); redo(); });
document.getElementById("clearActive").addEventListener("click", () => {
  closeAllMenus();
  if (activeDistrict <= 0) return;
  if (!confirm(`Unassign everything in District ${activeDistrict}?`)) return;
  unassignDistrict(activeDistrict);
});

function undo(){
  const patch = undoStack.pop();
  if (!patch) return;
  applyPatch(patch, -1);
  redoStack.push(patch);
  refreshStyles();
  geoLayer.eachLayer(layer => layer.setTooltipContent(tooltipHtml(layer.feature)));
  renderDistrictTable();
  renderActiveDistrictPanel();
  renderLabels();
  if (autosave) savePlan();
}
function redo(){
  const patch = redoStack.pop();
  if (!patch) return;
  applyPatch(patch, +1);
  undoStack.push(patch);
  refreshStyles();
  geoLayer.eachLayer(layer => layer.setTooltipContent(tooltipHtml(layer.feature)));
  renderDistrictTable();
  renderActiveDistrictPanel();
  renderLabels();
  if (autosave) savePlan();
}

document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key.toLowerCase() === "z"){ e.preventDefault(); undo(); }
  if (e.ctrlKey && e.key.toLowerCase() === "y"){ e.preventDefault(); redo(); }
});

// Map style dropdown
document.querySelectorAll('[data-style]').forEach(el => {
  el.addEventListener("click", () => {
    closeAllMenus();
    setTiles(el.getAttribute("data-style"));
  });
});
document.getElementById("togglePerf").addEventListener("click", () => {
  closeAllMenus();
  useCanvas = !useCanvas;
  // redraw geo layer with different renderer
  if (geoLayer){
    const gj = geoLayer.toGeoJSON();
    drawGeo(gj);
  }
});
document.getElementById("toggleAutosave").addEventListener("click", () => {
  closeAllMenus();
  autosave = !autosave;
  alert("Autosave: " + (autosave ? "ON" : "OFF"));
});

// K control
document.getElementById("incK").addEventListener("click", () => { setK(K+1); });
document.getElementById("decK").addEventListener("click", () => { setK(K-1); });

function setK(newK){
  const nk = clamp(Number(newK), 1, 60);
  if (nk === K) return;
  K = nk;
  // clamp any existing assignments above K
  const keys = [...assignments.keys()];
  const patch = [];
  for (const key of keys){
    const from = assignments.get(key) ?? 0;
    const to = clamp(from, 0, K);
    if (from !== to) patch.push({ key, from, to });
  }
  if (patch.length) pushHistory(patch);
  if (activeDistrict > K) activeDistrict = K;
  renderDistrictTable();
  renderActiveDistrictPanel();
  refreshStyles();
  renderLabels();
}

// toggles
["optFill","optLines","optHover"].forEach(id => {
  document.getElementById(id).addEventListener("change", () => refreshStyles());
});
document.getElementById("optLabels").addEventListener("change", () => renderLabels());


// Year selector (population + tooltips + deviation)
const yearSel = document.getElementById("yearSel");
if (yearSel){
  yearSel.value = String(activeYear);
  yearSel.addEventListener("change", () => {
    activeYear = Number(yearSel.value);
    renderDistrictTable();
    renderActiveDistrictPanel();
    refreshStyles();
    geoLayer?.eachLayer(layer => layer.setTooltipContent(tooltipHtml(layer.feature)));
    if (autosave) savePlan();
  });
}
// Search box
document.getElementById("searchBox").addEventListener("keydown", (e) => {
  if (e.key !== "Enter") return;
  const q = cleanLabel(e.target.value);
  if (!q) return;
  const qk = keyify(q);

  // 1) exact district match
  let bestLayer = null;
  geoLayer.eachLayer(layer => {
    const name = layer.feature?.properties?.name || "";
    if (keyify(name) === qk) bestLayer = layer;
  });

  // 2) province match (fit bounds of plate)
  if (!bestLayer){
    for (const [plate, prov] of Object.entries(PLATE_TO_PROVINCE_TR)){
      if (keyify(prov) === qk){
        const bb = L.latLngBounds();
        geoLayer.eachLayer(layer => {
          const p = featurePlate(layer.feature);
          if (Number(p) === Number(plate)) bb.extend(layer.getBounds());
        });
        if (bb.isValid()) map.fitBounds(bb, { padding:[20,20] });
        return;
      }
    }
  }

  if (bestLayer){
    map.fitBounds(bestLayer.getBounds(), { padding:[30,30] });
    // flash highlight
    bestLayer.setStyle(selectedStyle(bestLayer.feature));
    setTimeout(() => geoLayer.resetStyle(bestLayer), 800);
  }
});

/* ============================================================
   BOOT
   ============================================================ */
(async function boot(){
  // Load pop first (so tooltip has pop)
  try{
    const csvText = await fetchFirstOk(FILE_POP_CSV, false);
    parsePopulationCsv(csvText);
  }catch(e){
    console.warn(e);
  }

  // Load stored plan if any
  loadPlan();
  if (yearSel) yearSel.value = String(activeYear);

  // Optional province election JSONs
  let provincesLoaded = 0;
  try{
    provincesLoaded = await loadElectionAllProvincesLimited(6);
  }catch(_e){}

  // GeoJSON
  try{
    const geo = await fetchFirstOk(FILE_GEOJSON, true);
    drawGeo(geo);
  }catch(e){
    console.error(e);
    alert("GeoJSON failed to load. Open console for details.");
    return;
  }

  renderDistrictTable();
  renderActiveDistrictPanel();
  renderHoverPanel(null);
  refreshStyles();

  if (autosave) savePlan();
  console.log("Ready. Province election files loaded:", provincesLoaded);
})();
</script>
</body>
</html>
